---
title: "Environmental Data Project"
author: "Hetvi Dave, Nakul Nair, Vikas Vicraman"
date: "4/10/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

 ```{r knitr_init, echo=FALSE, cache=FALSE}
# DO NOT edit this block
knitr::opts_chunk$set(
  cache=TRUE,
  comment=NA,
  message=FALSE,
  warning=FALSE,
  fig.width=12,
  fig.height=7
)
```

```{r}
if(!require(pacman)) install.packages('pacman')
pacman::p_load(dplyr, ggplot2, mapproj, readr, ggthemes, viridis, tidyr, reshape2,maps, mapdata, ggmap, stringr, gstat,sp, automap)
```


** Filtering the petroleum data:**

```{r}
TRI <- read_csv('TRI_2016_TX.csv') %>%
  dplyr::select(LATITUDE,LONGITUDE, INDUSTRY_SECTOR,TOTAL_RELEASES)%>%
  filter(INDUSTRY_SECTOR == "Petroleum")
colnames(TRI)[colnames(TRI)=="LONGITUDE"] <- "long"
colnames(TRI)[colnames(TRI)=="LATITUDE"] <- "lat"
TRI
```

**Texas Map:**

```{r}
states <- map_data("state") 
texas <- subset(states, region %in% c("texas"))

texas_map <- ggplot(data = texas) + 
  geom_polygon(aes(x = long, y = lat, group = group), fill = "palegreen", color = "black") + 
  coord_fixed(1.3)
texas_map
```

**Counties in texas:**
```{r}
tx_df <- subset(states, region == "texas") 
counties <- map_data("county")
tx_county <- subset(counties, region == "texas")
tx_base <- ggplot(data = tx_df, mapping = aes(x = long, y = lat, group= group)) + 
  coord_fixed(1.3) + 
  geom_polygon(color = "black", fill = "gray")
tx_base +geom_polygon(data = tx_county, fill = NA, color = "white") + 
  geom_polygon(color = "black", fill = NA)
```

**PLotting petroleum data in the map:**
```{r}
texas_map+ geom_point(aes(x=long, y = lat, alpha=0.1) , data = TRI) + 
  scale_size_continuous(range=c(0.1, 1))+ 
  scale_color_viridis(option = 'magma') 


```

#KRIGING
```{r}
by_TRI <- TRI %>%
  group_by(long,lat) %>%
  summarise(Total_Release = sum(TOTAL_RELEASES))
by_TRI
```

```{r}
set.seed (2375)
test_size <- floor (0.4*nrow(by_TRI))
test_idx <- sample(seq_len(nrow(by_TRI)), size = test_size) 
train <- by_TRI[-test_idx , ] %>%
  as_tibble ()
test <- by_TRI [ test_idx , ] %>% 
  as_tibble ()

train
test
```

Creating spatial objects by assigning coords.

```{r}
train_sp <- train
coordinates(train_sp) <- ~long + lat
test_sp <- test
coordinates(test_sp) <- ~long + lat
```
Fitting variogram and a kriging model to the data using autoKrige function.
```{r}
krige_model <- autoKrige(
  formula = Total_Release ~ lat + long,
  input_data = train_sp,
  new_data = test_sp,
  data_variogram = train_sp,
  model = c ( "Sph", "Exp", "Gau", "Ste"),
  kappa = c ( 0.05, seq(0.2, 2, 0.1), 5, 10)
)
plot(krige_model)
```